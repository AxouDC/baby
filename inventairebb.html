<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Inventaire Bébé v2.2</title>
<style>
body{font-family:Arial, sans-serif;background:#f4f4f4;margin:0;padding:0}
header{background:#333;color:#fff;padding:10px 20px}
h1{margin:0;font-size:20px}
.container{padding:20px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:8px;text-align:left}
tr.red{background:#ffcccc}
tr.yellow{background:#fff6cc}
tr.green{background:#ccffcc}
button{padding:6px 10px;margin:4px;cursor:pointer}
#toast{position:fixed;bottom:20px;right:20px;background:#4caf50;color:#fff;padding:10px;border-radius:4px;display:none}
.modal{display:none;position:fixed;z-index:10;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,0.4)}
.modal-content{background:#fff;margin:10% auto;padding:20px;border:1px solid #888;width:300px;border-radius:6px}
.close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}
</style>
</head>
<body>
<header>
<h1>Inventaire Bébé</h1>
</header>
<div class="container">
<div id="tabs"></div>
<button id="addBtn">➕ Ajouter dans cet onglet</button>
<div id="tableContainer"></div>
</div>

<div id="addModal" class="modal">
<div class="modal-content">
<span class="close" id="closeModal">&times;</span>
<h3>Ajouter dans <span id="modalSheet"></span></h3>
<label>Objet:</label>
<select id="objSelect"></select><br>
ou nouveau: <input id="newObj"><br>
<label>Taille:</label>
<select id="tailleSelect"></select><br>
ou nouvelle: <input id="newTaille"><br>
<label>Quantité à ajouter:</label>
<input type="number" id="addQty" min="1" value="1"><br><br>
<button id="confirmAdd">Valider</button>
</div>
</div>

<div id="toast"></div>

<script>
const execUrl = "https://script.google.com/macros/s/AKfycbwLChjg9xy9xjzUkzHMlvhtyPW-EJ9VujnMIZxOsCXZcsGqq_ZXvVkbJcPK7uPleiZh1g/exec";
let data = {}, currentSheet = "Habits";

function showToast(msg, ok=true){
  const t = document.getElementById('toast');
  t.style.background = ok ? '#4caf50' : '#f44336';
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(()=>t.style.display='none',3000);
}

function colorClass(nec, pos){
  nec = parseInt(nec)||0; pos = parseInt(pos)||0;
  if(nec>0 && pos==0) return 'red';
  if(nec>0 && pos<nec) return 'yellow';
  if(nec>0 && pos>=nec) return 'green';
  return '';
}

function renderTabs(){
  const tabsDiv = document.getElementById('tabs');
  tabsDiv.innerHTML = '';
  ['Habits','Accessoires'].forEach(name=>{
    const b = document.createElement('button');
    b.textContent = name;
    if(name===currentSheet) b.style.fontWeight='bold';
    b.onclick=()=>{currentSheet=name; renderTable();};
    tabsDiv.appendChild(b);
  });
}

function renderTable(){
  const cont = document.getElementById('tableContainer');
  const rows = data[currentSheet] || [];
  let html = '<table><tr><th>Objet</th><th>Taille</th><th>Qté nécessaire</th><th>Qté possédée</th><th>Saison</th></tr>';
  rows.forEach(r=>{
    html += `<tr class="${colorClass(r['Qté nécessaire'], r['Qté possédée'])}">
      <td>${r.Objet||''}</td>
      <td>${r.Taille||''}</td>
      <td>${r['Qté nécessaire']}</td>
      <td>${r['Qté possédée']}</td>
      <td>${r.Saison||''}</td>
    </tr>`;
  });
  html += '</table>';
  cont.innerHTML = html;
}

async function loadSheet(name){
  const res = await fetch(execUrl+'?sheet='+encodeURIComponent(name));
  const js = await res.json();
  const rows = (js.rows||[]).filter(r=>(r.Objet||r.Taille||r.Saison));
  data[name] = rows;
}

async function loadAll(){
  await loadSheet('Habits');
  await loadSheet('Accessoires');
  renderTabs();
  renderTable();
}

document.getElementById('addBtn').onclick=()=>{
  const modal = document.getElementById('addModal');
  document.getElementById('modalSheet').textContent = currentSheet;
  const objs = [...new Set((data[currentSheet]||[]).map(r=>r.Objet).filter(Boolean))];
  const objSel = document.getElementById('objSelect');
  objSel.innerHTML = '<option value="">--</option>'+objs.map(o=>`<option>{o}</option>`).join('');
  const tailles = [...new Set((data[currentSheet]||[]).map(r=>r.Taille).filter(Boolean))];
  const tailleSel = document.getElementById('tailleSelect');
  tailleSel.innerHTML = '<option value="">--</option>'+tailles.map(o=>`<option>{o}</option>`).join('');
  modal.style.display='block';
};

document.getElementById('closeModal').onclick=()=>document.getElementById('addModal').style.display='none';

document.getElementById('confirmAdd').onclick=async()=>{
  const obj = document.getElementById('newObj').value || document.getElementById('objSelect').value;
  const taille = document.getElementById('newTaille').value || document.getElementById('tailleSelect').value;
  const qty = parseInt(document.getElementById('addQty').value)||0;
  if(!obj || !taille || qty<=0){alert('Champs incomplets');return;}
  let rows = data[currentSheet]||[];
  let found = rows.find(r=>r.Objet===obj && r.Taille===taille);
  if(found) found['Qté possédée'] = (parseInt(found['Qté possédée'])||0) + qty;
  else rows.push({Objet:obj, Taille:taille, 'Qté nécessaire':0, 'Qté possédée':qty, Saison:''});
  data[currentSheet]=rows;
  await fetch(execUrl,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'payload='+encodeURIComponent(JSON.stringify({sheet:currentSheet,rows:data[currentSheet]}))});
  showToast('Ajout effectué ✅', true);
  document.getElementById('addModal').style.display='none';
  renderTable();
};

window.onload=loadAll;
</script>
</body>
</html>