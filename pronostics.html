	<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pronostics ‚Äî La maison Rose (v5.9)</title>
  <style>
  :root{
    --bg:#fff7fa; --bg1:#fff1f6; --bg2:#ffeaf2;
    --card:#ffffff; --text:#3a2a30; --muted:#7b5f6a; --border:#efd7e5;
    --accent:#e470a2; --accent2:#f19ac0; --br:14px;
    --shadow:0 14px 40px rgba(223,130,170,.18);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,"Apple Color Emoji","Segoe UI Emoji";
    color:var(--text);
    background:
      radial-gradient(1200px 800px at 10% -10%, var(--bg1) 0, rgba(255,255,255,0) 60%),
      radial-gradient(1200px 800px at 110% -10%, var(--bg2) 0, rgba(255,255,255,0) 55%),
      var(--bg);
  }
  header{
    position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:12px;
    padding:14px 18px;
    background:linear-gradient(180deg, rgba(255,247,250,.92), rgba(255,247,250,.7) 70%, rgba(255,247,250,0));
    border-bottom:1px solid var(--border);
    backdrop-filter: blur(6px);
  }
  h1{margin:0;font-size:20px}
  header .spacer{flex:1}
  a.btn-ghost{
    text-decoration:none;color:var(--text);
    padding:8px 12px;border-radius:10px;border:1px solid var(--border);
    background:linear-gradient(180deg,#ffe9f3,#ffe2ee); font-size:14px
  }
  button.ghost{
    text-decoration:none;color:var(--text);
    padding:8px 12px;border-radius:10px;border:1px solid var(--border);
    background:linear-gradient(180deg,#ffe9f3,#ffe2ee); font-size:14px
  }
  button.primary{
    border:1px solid var(--accent);
    background:linear-gradient(180deg,var(--accent2),var(--accent));
    color:#fff;border-radius:10px;padding:10px 12px
  }
  button.danger{
    background:linear-gradient(180deg,#ffd5df,#ffb6c7);
    border:1px solid #f3a1b4;border-radius:10px;padding:10px 12px
  }
  input,select{
    width:100%;padding:12px 14px;border:1px solid var(--border);
    border-radius:10px;background:#fff7fb;color:var(--text)
  }
  .wrap{padding:14px 20px 28px;display:grid;grid-template-columns:520px 1fr;gap:16px;transition:grid-template-columns .2s}
  .wrap.collapsed{grid-template-columns:1fr}
  .wrap.collapsed #panelLeft{display:none}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--br);box-shadow:var(--shadow)}
  .card > .hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600;display:flex;align-items:center;gap:10px;justify-content:space-between}
  .card > .bd{padding:14px 16px}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
  .kpi{padding:12px;background:#fff;border:1px solid var(--border);border-radius:12px}
  table{width:100%;border-collapse:collapse;font-size:13px;background:#fff}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:top}
  th{position:sticky;top:0;background:#fff7fb;z-index:5}
  tr:hover td{background:#fff1f6}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff1f7;font-size:13px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#fff1f6;border:1px solid var(--border);color:#8c5b70;font-size:12px}
  #toastContainer{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:10px;z-index:9999}
  .toast{min-width:240px;max-width:360px;padding:12px 14px;border-radius:10px;color:#2b181d;background:#ffeef4;border:1px solid #f4cade;box-shadow:var(--shadow);font-size:14px}
  .toast.err{background:#fff0f0;border-color:#f3b6b6}
  #lockMask{position:fixed;inset:0;background:rgba(255,210,230,.45);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:9998}
  #lockCard{background:#fff;border:1px solid var(--border);border-radius:12px;padding:18px;width:clamp(280px,40vw,420px)}
  .chartBox{height:300px;padding:8px}
  canvas{width:100% !important;height:100% !important}
  .status{font-size:12px;color:var(--muted)}
  /* === KPIs : m√™me format que l‚Äôancienne page === */
.kpis{
  display:grid;
  grid-template-columns: repeat(4, minmax(160px, 1fr));
  gap:12px;
  margin-bottom:12px;
}
.kpi{
  padding:12px 14px;
  background:#fff;                 /* fond clair (rose p√¢le global conserve le th√®me) */
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow: var(--shadow);
}
.kpi > span.muted{
  font-size:12px;
  color: var(--muted);
}
.kpi > b{
  display:block;
  margin-top:6px;
  font-size:22px;                   /* taille identique √† l‚Äôancienne */
  font-weight:700;
  color: var(--text);
}
  </style>
</head>
<body>
<header>
  <h1>Pronostics de b√©b√© <span class="pill">La maison Rose</span></h1>
  <div class="spacer"></div>
  <a class="btn-ghost" href="https://axoudc.github.io/lamaisonrose/" target="_self">üè† Accueil</a>
</header>

<div class="wrap collapsed" id="wrap">
  <section class="card" id="panelLeft">
    <div class="hd">
      <span>Donn√©es (Google Sheets)</span>
      <div>
        <button class="ghost" id="btnTogglePanel" onclick="togglePanel()">Masquer le panneau</button>
        <button class="primary" id="btnUnlock" onclick="openLock()">D√©verrouiller la saisie</button>
      </div>
    </div>
    <div class="bd">
      <div class="status" id="cloudStatus"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 6px">
        <button class="primary" id="btnCloudLoad" onclick="loadFromCloud()">Charger depuis Google Sheets</button>
        <button id="btnCloudSave" onclick="saveToCloud()">Enregistrer vers Google Sheets</button>
      </div>
      <div class="pill">Par d√©faut, la saisie est verrouill√©e (code requis)</div>
      <hr style="border:none;border-top:1px solid var(--border);margin:14px 0">
      <form id="form" onsubmit="return submitForm(event)">
        <div class="grid" style="display:grid;gap:12px">
          <div><label>Joueur</label><input id="fJoueur" required placeholder=""></div>
          <div><label>Sexe</label>
            <select id="fSexe"><option value="">‚Äî</option><option>Fille</option><option>Gar√ßon</option><option>Ind√©termin√©</option></select>
          </div>
          <div><label>Pr√©nom(s)</label><input id="fPrenom" placeholder=""></div>
          <div><label>Taille (cm)</label><input id="fTaille" type="number" step="1" min="35" max="65" placeholder=""></div>
          <div><label>Poids (kg)</label><input id="fPoidsKg" type="number" step="0.001" min="2" max="6" placeholder=""></div>
          <div><label>Date</label><input id="fDate" type="date"></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button type="submit" class="primary">Enregistrer dans le tableau</button>
          <button type="button" id="btnCancel" class="ghost" onclick="cancelEdit()">Annuler</button>
          <span class="pill" id="editFlag" style="display:none">Mode √©dition</span>
        </div>
      </form>
    </div>
  </section>

  <section class="card" id="panelRight">
    <div class="hd">
      <span>Vue d‚Äôensemble</span>
      <button class="ghost" id="btnShowPanel" onclick="showPanel()">Afficher le panneau de saisie</button>
    </div>
    <div class="bd">
      <div class="kpis">
        <div class="kpi"><span class="muted">Participants</span><b id="kpiCount">0</b></div>
        <div class="kpi"><span class="muted">Poids moyen (kg)</span><b id="kpiPoids">‚Äî</b></div>
        <div class="kpi"><span class="muted">Taille moyenne (cm)</span><b id="kpiTaille">‚Äî</b></div>
        <div class="kpi"><span class="muted">Date moyenne</span><b id="kpiDateMoy">‚Äî</b></div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div class="card">
          <div class="hd">R√©partition Fille / Gar√ßon</div>
          <div class="bd chartBox"><canvas id="chartSexe"></canvas></div>
        </div>
        <div class="card">
          <div class="hd">Pr√©noms propos√©s</div>
          <div class="bd" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="muted" style="margin-bottom:6px">Fille</div>
              <div class="chips" id="chipsFille"></div>
            </div>
            <div>
              <div class="muted" style="margin-bottom:6px">Gar√ßon</div>
              <div class="chips" id="chipsGarcon"></div>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px">
        <input id="search" placeholder="Rechercher‚Ä¶" oninput="onSearch()" />
        <select id="sortBy" onchange="onSort()">
          <option value="">Tri (aucun)</option>
          <option value="Date">Date</option>
          <option value="Poids (kg)">Poids (kg)</option>
          <option value="Taille (cm)">Taille (cm)</option>
          <option value="Joueur">Joueur</option>
          <option value="Sexe">Sexe</option>
          <option value="Pr√©nom">Pr√©nom</option>
        </select>
        <button id="btnAddRow" onclick="addRow()">Ajouter</button>
        <button id="btnDeleteSel" class="danger" onclick="deleteSelected()">Supprimer s√©lection</button>
      </div>

      <div class="card" style="border:none;box-shadow:none">
        <div class="bd" style="padding:0">
          <div style="max-height:420px;overflow:auto;border-top-left-radius:12px;border-top-right-radius:12px">
            <table id="tbl">
              <thead>
                <tr>
                  <th style="width:28px"><input type="checkbox" id="chkAll" onchange="toggleAll(this)"></th>
                  <th>Joueur</th>
                  <th>Sexe</th>
                  <th>Pr√©nom</th>
                  <th>Taille (cm)</th>
                  <th>Poids (kg)</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </section>
</div>

<div id="toastContainer"></div>

<div id="lockMask">
  <div id="lockCard">
    <h3>D√©verrouiller la saisie</h3>
    <span class="muted">Entre le code pour permettre l‚Äôajout / √©dition / suppression.</span>
    <input id="lockInput" placeholder="Code" maxlength="8" />
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="primary" onclick="lockOk()">D√©verrouiller</button>
      <button class="ghost" onclick="lockCancel()">Annuler</button>
    </div>
    <div class="muted" id="lockMsg" style="margin-top:6px"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ===== Config ===== */
const CLOUD_URL = "https://script.google.com/macros/s/AKfycbxpUz1Oh4YtlZCJ1z-UMuISVa_Nkl4UjcdvbX7VLe9wfmqNFSXGw4AHN2n2ENOmQZAb/exec";
const PASSCODE = "2983";
const COLS = ["Joueur","Sexe","Pr√©nom","Taille (cm)","Poids (kg)","Date"];

/* ===== State ===== */
let rows = []; let filtered = []; let editIndex = null;
let unlocked = false; let chartSexe = null;

/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);

function showToast(msg, ok=true, small=""){
  const cont = byId("toastContainer");
  const t = document.createElement("div");
  t.className = "toast" + (ok ? "" : " err");
  t.textContent = msg;
  if (small){
    const span = document.createElement("span");
    span.style.display = "block";
    span.style.fontSize = "12px";
    span.style.opacity = ".8";
    span.textContent = small;
    t.appendChild(span);
  }
  cont.appendChild(t);
  setTimeout(()=>t.remove(), 3500);
}
function setCloudStatus(msg, err=false){
  const s = byId('cloudStatus');
  s.textContent = msg;
  s.style.color = err ? '#b03a48' : '#7b5f6a';
}
function normalizeSexe(s){
  if(!s) return "";
  const x = String(s).trim().toLowerCase();
  if(x.startsWith("f")) return "Fille";
  if(x.startsWith("g")) return "Gar√ßon";
  return s;
}
function parseNumber(n){
  if(n===null || n===undefined || n==="") return null;
  const v = String(n).replace(",", ".").replace(/[^0-9.\-]/g,"");
  const f = parseFloat(v);
  return isFinite(f) ? f : null;
}
function parseDateAny(d){
  if(d==null || d==="") return "";
  if(typeof d==="number"){ const epoch = new Date(Date.UTC(1899,11,30)); return new Date(epoch.getTime() + d * 86400000).toISOString(); }
  const t = new Date(d);
  if(!isNaN(t)) return t.toISOString();
  const m = String(d).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m){ const [_,dd,mm,yy] = m; return new Date(+yy, +mm-1, +dd).toISOString(); }
  return "";
}
function splitPrenoms(val){
  if(!val) return [];
  return String(val).split(/[;,/|]/).map(s=>s.trim()).filter(Boolean);
}
const fmt = {
  kg: v => (isFinite(v)? (Math.round(v*1000)/1000).toFixed(3) : ""),
  cm: v => (isFinite(v)? Math.round(v) : ""),
  date: v => {
    if(!v) return "";
    const d=new Date(v); if(isNaN(d)) return String(v);
    const pad=n=>String(n).padStart(2,"0");
    return pad(d.getDate())+"/"+pad(d.getMonth()+1)+"/"+d.getFullYear();
  },
};
function escapeHtml(s){ return String(s??"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }

/* ===== Core ===== */
function cleanAndNormalize(arr){
  const aliasPrenom = ["Pr√©nom","Prenom","Pr√©noms","Prenoms","Pr√©nom propos√©","Prenom propose","Pr√©nom pressenti","Prenom pressenti","prenom","pr√©nom"];
  return arr
    .filter(o=>o && typeof o==="object")
    .map(o=>({
      "Joueur": (o["Joueur"]||o["joueur"]||"").toString().trim(),
      "Sexe": normalizeSexe(o["Sexe"]||o["sexe"]),
      "Pr√©nom": (()=>{ for(const k of aliasPrenom){ if(o[k]) return o[k]; } return (o["Pr√©nom"]||""); })().toString().trim(),
      "Taille (cm)": parseNumber(o["Taille (cm)"]||o["Taille"]),
      "Poids (kg)": parseNumber(o["Poids (kg)"]||o["Poids"]),
      "Date": parseDateAny(o["Date"]||o["date"]),
    }))
    .filter(o=> !COLS.every(k=> (o[k]==null || (typeof o[k]==="string" && o[k].trim()==="")) ));
}

function filterAndSort(){
  const q = byId("search").value.trim().toLowerCase();
  const sortKey = byId("sortBy").value;
  filtered = rows.filter(r => {
    if(!q) return true;
    return COLS.some(k => (r[k]??"").toString().toLowerCase().includes(q));
  });
  if(sortKey){
    filtered.sort((a,b)=>{
      if(sortKey==="Date") return (a.Date||"").localeCompare(b.Date||"");
      const va=a[sortKey], vb=b[sortKey];
      if(typeof va==="number" && typeof vb==="number") return va - vb;
      return (va??"").toString().localeCompare((vb??"").toString(),"fr");
    });
  }
}

function renderTable(){
  const tb = byId("tbl").querySelector("tbody");
  tb.innerHTML = "";
  filtered.forEach((r, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" data-idx="${i}" ${!unlocked?'disabled':''}></td>
      <td>${escapeHtml(r["Joueur"])}</td>
      <td>${escapeHtml(r["Sexe"]||"")}</td>
      <td>${escapeHtml(r["Pr√©nom"]||"")}</td>
      <td>${fmt.cm(r["Taille (cm)"])}</td>
      <td>${fmt.kg(r["Poids (kg)"])}</td>
      <td>${fmt.date(r["Date"])}</td>`;
    if(unlocked) tr.ondblclick=()=>startEdit(findGlobalIndex(i));
    tb.appendChild(tr);
  });
  byId("kpiCount").textContent = String(rows.length);
}

function renderNamesBySexe(){
  const mapF = new Map(), mapG = new Map();
  rows.forEach(r=>{
    const s = normalizeSexe(r["Sexe"]);
    const list = splitPrenoms(r["Pr√©nom"]);
    const seen = new Set();
    list.forEach(p=>{
      const key = p.charAt(0).toUpperCase()+p.slice(1);
      if(seen.has(key)) return; seen.add(key);
      if(s==="Fille") mapF.set(key, (mapF.get(key)||0)+1);
      else if(s==="Gar√ßon") mapG.set(key, (mapG.get(key)||0)+1);
    });
  });
  const renderChips=(sel,map)=>{
    const box=$(sel); box.innerHTML="";
    if(map.size===0){ box.innerHTML='<span class="muted">‚Äî</span>'; return; }
    Array.from(map.entries()).sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0],"fr")).forEach(([name,count])=>{
      const c=document.createElement("span"); c.className="chip"; c.textContent=name+(count>1?` √ó${count}`:""); box.appendChild(c);
    });
  };
  renderChips("#chipsFille", mapF); renderChips("#chipsGarcon", mapG);
}

function computeStats(){
  const nums=k=> rows.map(r=>r[k]).filter(v=>typeof v==="number"&&isFinite(v));
  const avg=a=> a.length? a.reduce((x,y)=>x+y,0)/a.length : null;
  const p=avg(nums("Poids (kg)")), t=avg(nums("Taille (cm)"));
  byId("kpiPoids").textContent = p!=null? fmt.kg(p) : "‚Äî";
  byId("kpiTaille").textContent = t!=null? fmt.cm(t) : "‚Äî";
  const dates=rows.map(r=>r.Date? new Date(r.Date).getTime():null).filter(v=>v!=null&&isFinite(v));
  byId("kpiDateMoy").textContent = dates.length? fmt.date(new Date(Math.round(dates.reduce((a,b)=>a+b,0)/dates.length))) : "‚Äî";
  renderNamesBySexe();
}

function buildChartSexe(){
  const counts={Fille:0,"Gar√ßon":0};
  rows.forEach(r=>{ const s=normalizeSexe(r["Sexe"]); if(s==="Fille") counts.Fille++; else if(s==="Gar√ßon") counts["Gar√ßon"]++; });
  const ctx=document.getElementById("chartSexe"); if(!ctx) return;
  if(chartSexe) chartSexe.destroy();
  chartSexe = new Chart(ctx,{ type:"bar",
    data:{ labels:["Fille","Gar√ßon"], datasets:[{ data:[counts.Fille, counts["Gar√ßon"]] }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{beginAtZero:true, ticks:{precision:0}}} }
  });
}

function refresh(){
  filterAndSort(); renderTable(); computeStats(); buildChartSexe();
  const all = byId("chkAll"); if(all) all.checked=false;
  setLockedUI();
}

/* ===== Cloud sync (robuste) ===== */
async function loadFromCloud(){
  const ts = Date.now();
  const url = CLOUD_URL + "?ts=" + ts;
  setCloudStatus("Chargement‚Ä¶");
  try{
    const res = await fetch(url, { method:"GET", cache:"no-store" });
    const rawText = await res.text();
    let js;
    try { js = JSON.parse(rawText); } catch(_){ js = rawText; }
    let arr = [];
    if(Array.isArray(js?.rows)) arr = js.rows;
    else if (Array.isArray(js?.data)) arr = js.data;
    else if (Array.isArray(js?.values)) {
      const vals = js.values;
      const headers = (vals[0]||[]).map(h=>String(h).trim());
      for(let i=1;i<vals.length;i++){
        const obj={};
        (vals[i]||[]).forEach((v,idx)=> obj[headers[idx]||("Col"+idx)] = v );
        arr.push(obj);
      }
    } else if (Array.isArray(js)) {
      arr = js;
    } else {
      throw new Error("R√©ponse inattendue. Extrait: " + String(rawText).slice(0,120));
    }
    rows = cleanAndNormalize(arr);
    refresh();
    setCloudStatus(`Charg√© (${rows.length} lignes).`);
    showToast("Chargement r√©ussi ‚úÖ", true, `Lignes: ${rows.length}`);
  } catch(e){
    console.error(e);
    setCloudStatus("Erreur de chargement : " + (e.message||e), true);
    showToast("√âchec du chargement ‚ùå", false, e.message||String(e));
  }
}

async function saveToCloud(){
  if(!unlocked) return;
  const btn = byId("btnCloudSave");
  btn.disabled=true; const old=btn.textContent; btn.textContent="Enregistrement‚Ä¶";
  setCloudStatus("Enregistrement‚Ä¶");
  try{
    const payload = {
      rows: rows.map(r => ({
        "Joueur": r["Joueur"]||"",
        "Sexe": r["Sexe"]||"",
        "Pr√©nom": r["Pr√©nom"]||"",
        "Taille (cm)": r["Taille (cm)"]??"",
        "Poids (kg)": r["Poids (kg)"]??"",
        "Date": r["Date"] ? fmt.date(r["Date"]) : ""
      }))
    };
    const res = await fetch(CLOUD_URL, {
      method:"POST",
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    const txt = await res.text();
    if(!res.ok) throw new Error("HTTP "+res.status+" ‚Äî "+txt.slice(0,120));
    setCloudStatus("Enregistr√© ‚úÖ"); showToast("Enregistrement r√©ussi ‚úÖ");
  } catch(e){
    console.error(e);
    setCloudStatus("Erreur d'enregistrement : " + (e.message||e), true);
    showToast("√âchec de l'enregistrement ‚ùå", false, e.message||String(e));
  } finally {
    btn.textContent=old; btn.disabled=false;
  }
}

/* ===== Table & edit ===== */
function toggleAll(master){
  document.querySelectorAll('#tbl tbody input[type="checkbox"]').forEach(c=> c.checked = master.checked);
}
function deleteSelected(){
  if(!unlocked) return;
  const checks=[...document.querySelectorAll('#tbl tbody input[type="checkbox"]')];
  const idxs = checks.filter(c=>c.checked).map(c=> parseInt(c.dataset.idx||"-1",10)).filter(i=>i>=0);
  rows = rows.filter((_,i)=> !idxs.includes(i));
  refresh();
}
function addRow(){ if(!unlocked) return; editIndex=null; byId("form").reset(); byId("fJoueur").focus(); }
function startEdit(i){
  if(!unlocked || i==null) return;
  editIndex=i;
  const r=rows[i];
  byId("fJoueur").value=r["Joueur"]||"";
  byId("fSexe").value=r["Sexe"]||"";
  byId("fPrenom").value=r["Pr√©nom"]||"";
  byId("fTaille").value=r["Taille (cm)"]??"";
  byId("fPoidsKg").value=r["Poids (kg)"]??"";
  byId("fDate").value=r["Date"]? toYMD(new Date(r["Date"])):"";
  byId("editFlag").style.display="inline-block"; byId("fJoueur").focus();
}
function cancelEdit(){ editIndex=null; byId("form").reset(); byId("editFlag").style.display="none"; }
function submitForm(e){
  e.preventDefault();
  if(!unlocked) return false;
  const iso = byId("fDate").value? new Date(byId("fDate").value+"T12:00:00").toISOString() : "";
  const obj={
    "Joueur": byId("fJoueur").value.trim(),
    "Sexe": normalizeSexe(byId("fSexe").value),
    "Pr√©nom": byId("fPrenom").value.trim(),
    "Taille (cm)": parseNumber(byId("fTaille").value),
    "Poids (kg)": parseNumber(byId("fPoidsKg").value),
    "Date": iso
  };
  if(editIndex!=null) rows[editIndex]=obj; else rows.push(obj);
  cancelEdit(); refresh();
  return false;
}
const toYMD = d => d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
function findGlobalIndex(filteredIdx){
  const target = filtered[filteredIdx]; if(!target) return null;
  return rows.indexOf(target);
}

/* ===== Volet ===== */
function togglePanel(){
  const wrap = byId("wrap"); const btnShow = byId("btnShowPanel");
  if(!wrap || !btnShow) return;
  wrap.classList.add("collapsed"); btnShow.style.display="inline-block";
}
function showPanel(){
  const wrap = byId("wrap"); const btnShow = byId("btnShowPanel");
  if(!wrap || !btnShow) return;
  wrap.classList.remove("collapsed"); btnShow.style.display="none";
}

/* ===== Lock modal ===== */
function openLock(){
  byId("lockMsg").textContent="";
  byId("lockInput").value="";
  byId("lockMask").style.display="flex";
  setTimeout(()=> byId("lockInput").focus(), 50);
}
function lockCancel(){ byId("lockMask").style.display="none"; }
function lockOk(){
  const v = byId("lockInput").value.trim();
  if(v === PASSCODE){
    unlocked = true; byId("lockMask").style.display="none";
    showToast("Saisie d√©verrouill√©e üîì"); setLockedUI();
  } else {
    byId("lockMsg").textContent = "Code incorrect.";
  }
}
function setLockedUI(){
  const disable = (sel, d) => document.querySelectorAll(sel).forEach(x=> x.disabled = d);
  disable("#btnCloudSave", !unlocked);
  disable("#btnDeleteSel", !unlocked);
  disable("#btnAddRow", !unlocked);
  document.querySelectorAll("#form input, #form select, #form button[type='submit']").forEach(x=> x.disabled = !unlocked);
}

/* ===== Search/Sort bindings ===== */
function onSearch(){ filterAndSort(); renderTable(); }
function onSort(){ filterAndSort(); renderTable(); }

/* ===== Init ===== */
(async function init(){
  try { await loadFromCloud(); } catch(e){ /* toasts g√®rent */ }
  finally { setLockedUI(); byId("btnShowPanel").style.display="inline-block"; }
})();
</script>
</body>
</html>
